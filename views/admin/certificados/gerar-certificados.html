{% extends '/admin/base/base.html' %} 
{% block conteudo %}
<!-- Incluir Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<div class="app-content-body">
  <div class="container-fluid">
    <!-- Nav tabs para abas -->
    <ul class="nav nav-tabs mb-3" id="certificadosTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button" role="tab">Lista de Contemplados</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="visualizacao-tab" data-bs-toggle="tab" data-bs-target="#visualizacao" type="button" role="tab">Visualização</button>
      </li>
    </ul>
    <!-- Conteúdo das abas -->
    <div class="tab-content" id="certificadosTabContent">
      <!-- Aba de Lista -->
      <div class="tab-pane fade show active" id="lista" role="tabpanel">
        <div class="alert alert-warning">
            <strong>Instruções:</strong> 
            <div id="instrucoesDinamicas">
                <!-- As instruções serão geradas dinamicamente aqui -->
            </div>
            
            <div class="mt-3">
                <strong>Placeholders disponíveis neste modelo:</strong>
                <div id="placeholdersModelo" class="mt-2"></div>
            </div>
        </div>

        <form id="configuracaoForm">
          <!-- Seção para Valores Globais (Tags Específicas) -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Valores Globais do Certificado</h5>
            </div>
            <div class="card-body">
              <p class="text-muted">Estes valores serão aplicados a <strong>todos os certificados</strong> gerados:</p>
              <div id="camposGlobais" class="row">
                <!-- Os campos globais serão gerados dinamicamente aqui -->
              </div>
            </div>
          </div>

          <!-- Seção para Dados dos Alunos -->
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Dados dos Contemplados</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="listaAlunos" class="form-label">Lista de Contemplados</label>
                <textarea id="listaAlunos" name="listaAlunos" rows="10" class="form-control" 
                          placeholder="Insira apenas os dados que variam por aluno (nome, CPF, etc.) no formato: Nome (separador, ex: |, ;) CPF"></textarea>
                <div class="form-text">Insira um aluno por linha. Use o separador escolhido abaixo.</div>
              </div>
              
              <div class="mb-3">
                <label for="separador" class="form-label">Separador</label>
                <select id="separador" name="separador" class="form-select">
                  <option value="|">Pipe (|)</option>
                  <option value=";">Ponto e vírgula (;)</option>
                  <option value=",">Vírgula (,)</option>
                  <option value="tab">Tabulação</option>
                </select>
              </div>

              <button type="button" id="processarLista" class="btn btn-primary">Processar Lista</button>
            </div>
          </div>
        </form>

        <div id="resultadoProcessamento" class="mt-4 d-none">
          <h3>Alunos Processados</h3>
          <div id="listaAlunosProcessados" class="alert alert-secondary"></div>
          <button type="button" id="gerarCertificados" class="btn btn-dark">Gerar Todos os Certificados</button>
        </div>
      </div>

      <!-- Aba de Visualização -->
      <div class="tab-pane fade" id="visualizacao" role="tabpanel">
        <div class="d-flex justify-content-center mb-3">
          <div class="border rounded overflow-auto" style="max-width: 100%">
            <canvas id="preview" class="d-block mx-auto"></canvas>
          </div>
        </div>
        
        <div class="d-flex justify-content-center mb-3">
          <div class="btn-group" role="group">
            <button type="button" id="paginaAnterior" class="btn btn-secondary">Página Anterior</button>
            <button type="button" id="paginaAtual" class="btn btn-primary" disabled>Página 1</button>
            <button type="button" id="proximaPagina" class="btn btn-secondary">Próxima Página</button>
          </div>
        </div>
        
        <div id="alunoSelecionado" class="alert alert-warning d-none justify-content-between align-items-center"></div>
        
        <div class="d-flex gap-2">
          <button type="button" id="baixarIndividual" class="btn btn-primary d-none"><i class="bi bi-download"></i>Baixar Este Certificado</button>
          <button type="button" id="baixarTodos" class="btn btn-dark d-none"><i class="bi bi-download"></i>Baixar Todos os Certificados</button>
        </div>
      </div>
    </div>
  </div>
</div>
{{modeloRaw|raw}}
{{baseUrlValidacao|raw}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="/assets/js/certificados/gerar-certificados.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tutorialGerarCertificadosVisto = localStorage.getItem('tutorial_gerar_certificados_visto');
    
    function iniciarTutorialGerarCertificados() {
        const driver = window.driver.js.driver;

        function scrollToElement(selector) {
            const element = document.querySelector(selector);
            if (element) {
                element.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                    inline: 'center'
                });
            }
        }

        let driverObj = driver({
            popoverClass: 'bg-' + temaAlerta + ' text-body',
            showProgress: true,
            steps: [
                {
                    element: ".nav-tabs",
                    popover: {
                        title: 'Geração de Certificados em Massa <i class="bi bi-card-checklist"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Bem-vindo ao gerador de certificados em massa!</strong></p>
                            <p>Aqui você pode gerar múltiplos certificados de uma vez usando um modelo pré-definido.</p>
                            <p class="mb-0">Vamos explorar todo o processo passo a passo!</p>
                        </div>
                        `,
                        side: "bottom",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#instrucoesDinamicas');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#instrucoesDinamicas",
                    popover: {
                        title: 'Instruções Dinâmicas <i class="bi bi-info-circle"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>As instruções mudam conforme o modelo selecionado.</strong></p>
                            <p>Aqui você encontra:</p>
                            <ul class="small">
                                <li>Formato correto para inserir os dados</li>
                                <li>Campos obrigatórios detectados</li>
                                <li>Exemplos práticos de preenchimento</li>
                                <li>Informações sobre tags específicas</li>
                            </ul>
                            <p class="mb-0"><em>Sempre verifique estas instruções antes de começar</em></p>
                        </div>
                        `,
                        side: "bottom",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#placeholdersModelo');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#placeholdersModelo",
                    popover: {
                        title: 'Placeholders Disponíveis <i class="bi bi-tags"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Tags que podem ser usadas no modelo.</strong></p>
                            <p>Tags comuns:</p>
                            <ul class="small">
                                <li><code>{nome}</code> - Nome do aluno</li>
                                <li><code>{cpf}</code> - CPF</li>
                                <li><code>{curso}</code> - Nome do curso</li>
                                <li><code>{cargahoraria}</code> - Carga horária</li>
                            </ul>
                        </div>
                        `,
                        side: "bottom",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#camposGlobais');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#camposGlobais",
                    popover: {
                        title: 'Valores Globais <i class="bi bi-globe"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Configure valores que serão iguais em todos os certificados.</strong></p>
                            <p>Use para informações como:</p>
                            <ul class="small">
                                <li>Nome do curso</li>
                                <li>Carga horária</li>
                                <li>Local do evento</li>
                                <li>Data de emissão</li>
                                <li>Conteúdo programático</li>
                            </ul>
                            <p class="mb-0"><em>Estes valores se aplicam a TODOS os certificados gerados</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            const quillEditor = document.querySelector('#quillEditor');
                            if (quillEditor) {
                                scrollToElement('#quillEditor');
                                driverObj.moveNext();
                            } else {
                                scrollToElement('#listaAlunos');
                                driverObj.moveNext();
                            }
                        },
                    },
                },
                
                {
                    element: "#listaAlunos",
                    popover: {
                        title: 'Lista de Contemplados <i class="bi bi-people"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Insira os dados dos alunos que receberão certificados.</strong></p>
                            <p>Formato esperado:</p>
                            <ul class="small">
                                <li>Um aluno por linha</li>
                                <li>Use o separador escolhido</li>
                                <li>Apenas dados que variam por aluno</li>
                                <li>Ex: <code>João Silva | 123.456.789-00</code></li>
                            </ul>
                            <p class="mb-0"><em>Dados globais já foram configurados na seção anterior</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#separador');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#separador",
                    popover: {
                        title: 'Seleção de Separador <i class="bi bi-columns-gap"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Escolha o caractere que separa os campos.</strong></p>
                            <p>Opções disponíveis:</p>
                            <ul class="small">
                                <li><strong>Pipe (|):</strong> Mais comum e seguro</li>
                                <li><strong>Ponto e vírgula (;):</strong> Alternativa boa</li>
                                <li><strong>Vírgula (,):</strong> Cuidado com decimais</li>
                                <li><strong>Tabulação:</strong> Para copiar de Excel</li>
                            </ul>
                            <p class="mb-0"><em>Recomendado: Use Pipe (|) para maior compatibilidade</em></p>
                        </div>
                        `,
                        side: "right",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#processarLista');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#processarLista",
                    popover: {
                        title: 'Processar Lista <i class="bi bi-gear"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Clique para validar e processar a lista de alunos.</strong></p>
                            <p>Esta função:</p>
                            <ul class="small">
                                <li>Valida o formato dos dados</li>
                                <li>Verifica campos obrigatórios</li>
                                <li>Prepara para geração em massa</li>
                                <li>Mostra preview dos dados</li>
                            </ul>
                            <p class="mb-0"><em>Execute esta etapa antes de gerar os certificados</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            document.getElementById('visualizacao-tab').click();
                            setTimeout(() => {
                                scrollToElement('#preview');
                                driverObj.moveNext();
                            }, 300);
                        },
                    },
                },
                {
                    element: "#preview",
                    popover: {
                        title: 'Visualização do Certificado <i class="bi bi-eye"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Preview em tempo real do certificado.</strong></p>
                            <p>Aqui você pode:</p>
                            <ul class="small">
                                <li>Ver como ficará o certificado final</li>
                                <li>Navegar entre páginas (se houver)</li>
                                <li>Verificar substituição das tags</li>
                                <li>Validar o layout e conteúdo</li>
                            </ul>
                            <p class="mb-0"><em>Visualização em alta qualidade - igual ao PDF final</em></p>
                        </div>
                        `,
                        side: "left",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#paginaAnterior');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#preview",
                    popover: {
                        title: 'Navegação entre Páginas <i class="bi bi-arrow-left-right"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Controle a visualização de páginas múltiplas.</strong></p>
                            <p>Use estes controles para:</p>
                            <ul class="small">
                                <li>Ver página anterior</li>
                                <li>Ver próxima página</li>
                                <li>Acompanhar página atual</li>
                            </ul>
                            <p class="mb-0"><em>Alguns certificados podem ter anexos ou páginas adicionais</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#alunoSelecionado');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#preview",
                    popover: {
                        title: 'Navegação entre Alunos <i class="bi bi-person-check"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Visualize certificados de diferentes alunos.</strong></p>
                            <p>Quando houver múltiplos alunos:</p>
                            <ul class="small">
                                <li>Veja qual aluno está sendo visualizado</li>
                                <li>Navegue para anterior/próximo</li>
                                <li>Controle: "X de Y" alunos</li>
                            </ul>
                            <p class="mb-0"><em>Use para verificar todos os certificados antes do download</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#baixarIndividual');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#preview",
                    popover: {
                        title: 'Download Individual <i class="bi bi-download"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Baixe o certificado do aluno atual.</strong></p>
                            <p>Ideal para:</p>
                            <ul class="small">
                                <li>Testar um certificado específico</li>
                                <li>Envio individual por email</li>
                                <li>Correções pontuais</li>
                                <li>Verificação de qualidade</li>
                            </ul>
                            <p class="mb-0"><em>Gera um PDF com o nome do aluno automaticamente</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            scrollToElement('#baixarTodos');
                            driverObj.moveNext();
                        },
                    },
                },
                {
                    element: "#preview",
                    popover: {
                        title: 'Download em Massa <i class="bi bi-file-earmark-zip"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Baixe todos os certificados de uma vez.</strong></p>
                            <p>Funcionalidades:</p>
                            <ul class="small">
                                <li>Gera todos os certificados</li>
                                <li>Cria um arquivo ZIP</li>
                                <li>Organiza por nome do aluno</li>
                                <li>Preserva a qualidade original</li>
                            </ul>
                            <p class="mb-0"><em>Recomendado para emissão em lote - arquivo: certificados.zip</em></p>
                        </div>
                        `,
                        side: "top",
                        align: "start",
                        onNextClick: () => {
                            document.getElementById('lista-tab').click();
                            setTimeout(() => {
                                driverObj.moveNext();
                            }, 300);
                        },
                    },
                },
                {
                    element: ".aba",
                    popover: {
                        title: 'Tour Concluído! <i class="bi bi-check-circle"></i>',
                        description: `
                        <div class="text-start">
                            <p><strong>Você conheceu todas as funcionalidades do gerador de certificados!</strong></p>
                            <p>Agora você pode:</p>
                            <ul class="small">
                                <li>Configurar valores globais para todos os certificados</li>
                                <li>Inserir listas de alunos de forma eficiente</li>
                                <li>Visualizar e validar cada certificado</li>
                                <li>Baixar individualmente ou em lote</li>
                            </ul>
                            <p class="mb-0">Lembre-se: você pode reiniciar este tour a qualquer momento clicando no botão "Tour do Gerador".</p>
                        </div>
                        `,
                        side: "center",
                        align: "start",
                        onNextClick: () => { 
                            localStorage.setItem('tutorial_gerar_certificados_visto', 'true');
                            driverObj.destroy();  
                        },
                    },
                }
            ],
            onDestroyed: () => {
                localStorage.setItem('tutorial_gerar_certificados_visto', 'true');
            }
        });

        driverObj.drive();
    }

    if (!tutorialGerarCertificadosVisto) {
        setTimeout(() => {
            iniciarTutorialGerarCertificados();
        }, 300);
    }

    const botaoTourGerar = document.createElement('button');
    botaoTourGerar.className = 'btn btn-warning position-fixed';
    botaoTourGerar.style.cssText = 'position: fixed; bottom: 7px; right: 70px; z-index: 999999;';
    botaoTourGerar.innerHTML = '<i class="bi bi-card-checklist"></i> Tour do Gerador';
    botaoTourGerar.addEventListener('click', iniciarTutorialGerarCertificados);
    
    document.body.appendChild(botaoTourGerar);
});
</script>
{% endblock %}